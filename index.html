<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜ì–´íšŒí™” ìŠ¤í„°ë””</title>
  <style>
    :root{
      --main:#4f46e5; --bg:#f4f6fb; --card:#fff; --text:#1f2937;
      --danger:#dc2626; --muted:#6b7280; --line:#e5e7eb;
      --ok:#16a34a; --warn:#f59e0b;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:var(--text);}
    header{background:var(--main);color:#fff;display:flex;justify-content:space-around;padding:12px 0;position:sticky;top:0;z-index:5;}
    header button{background:none;border:none;color:#fff;font-size:14px;cursor:pointer;padding:8px 10px;border-radius:10px;}
    header button.active{background:rgba(255,255,255,.18);}
    .container{padding:16px;max-width:980px;margin:0 auto;}
    .card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 8px 22px rgba(0,0,0,0.06);}
    .hidden{display:none;}
    .primary{background:var(--main);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;}
    .primary:active{transform:translateY(1px);}
    .sub{background:#eef2ff;border:1px solid #c7d2fe;padding:12px;border-radius:12px;width:100%;margin-bottom:8px;cursor:pointer;text-align:left;font-weight:700;}
    .sub.active{background:var(--main);color:#fff;border-color:var(--main);}
    input,select{width:100%;padding:11px;margin-top:6px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px;}
    .danger{background:var(--danger);color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800;}
    .ghost{background:#fff;border:1px solid var(--line);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;}
    .small{font-size:13px;color:var(--muted);line-height:1.4;}
    .ok{color:var(--ok);font-weight:900;}
    .no{color:var(--danger);font-weight:900;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .row > *{flex:1;min-width:140px;}
    .pill{display:inline-block;padding:5px 10px;border-radius:999px;background:#f3f4f6;font-size:12px;color:#111;}
    .note{padding:12px;border-radius:12px;background:#f9fafb;border:1px dashed var(--line);}
    hr.sep{border:none;border-top:1px solid var(--line);margin:12px 0;}
    .listItem{border-top:1px dashed var(--line);padding-top:12px;margin-top:12px;}
    .kpi{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
    .kpi .big{font-size:24px;font-weight:950;letter-spacing:-0.3px;}
    .banner{
      padding:14px;border-radius:14px;background:linear-gradient(135deg,#eef2ff,#ffffff);
      border:1px solid #dbeafe;
    }

    /* ì²´í¬ë°•ìŠ¤ ì˜ì—­(ëª¨ë°”ì¼ì—ì„œ í™”ë©´ ë°–ìœ¼ë¡œ ì•ˆ ë‚˜ê°€ê²Œ) */
    .chkGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;}
    .chkGrid label{
      display:flex;gap:8px;align-items:center;
      padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer;
      min-width:0; /* ì¤„ë°”ê¿ˆ í—ˆìš© */
      font-size:14px;
    }
    .chkGrid input{width:auto;margin:0;flex:none;}
    @media (max-width:520px){
      .chkGrid{max-width:80vw;} /* ìš”ì²­: 5ë¶„ì˜4 ì •ë„ */
      .chkGrid label{font-size:13px;padding:9px;}
      header{gap:6px;flex-wrap:wrap;}
    }

    /* ëª¨ë‹¬ */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.38);
      display:flex;align-items:center;justify-content:center;
      z-index:9999;padding:18px;
    }
    .modal{
      width:min(520px, 92vw);
      background:#fff;border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      overflow:hidden;
      transform:translateY(10px) scale(.98);
      animation:pop .18s ease-out forwards;
    }
    @keyframes pop{
      to{transform:translateY(0) scale(1);}
    }
    .modalTop{
      padding:18px 18px 12px;
      background:linear-gradient(135deg,#4f46e5,#7c3aed);
      color:#fff;
    }
    .modalTop h3{margin:0;font-size:18px;letter-spacing:-0.2px;}
    .modalBody{padding:16px 18px;}
    .modalBody .bigMsg{font-size:20px;font-weight:950;letter-spacing:-0.4px;line-height:1.35;}
    .modalBody .subMsg{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.45;}
    .modalActions{padding:14px 18px;display:flex;justify-content:flex-end;gap:10px;background:#fafafa;border-top:1px solid var(--line);}
  </style>
</head>

<body>

<!-- ì´ë¦„ ì„ íƒ -->
<div id="nameScreen" class="container">
  <div class="card">
    <h2 style="margin:0 0 10px;">ì´ë¦„ ì„ íƒ</h2>

    <select id="userSelect">
      <option value="">ì„ íƒ</option>
      <option>ì˜¤ì„¤ë€</option>
      <option>ì˜¤ë¯¸ì§„</option>
      <option>ê¹€ë¯¸ë‚˜</option>
    </select>

    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
      <input id="rememberMe" type="checkbox" style="width:auto; margin:0;">
      <label for="rememberMe" class="small" style="margin:0; cursor:pointer;">
        ë¡œê·¸ì¸ ìœ ì§€(ì²´í¬í•˜ë©´ ë‹¤ìŒë¶€í„° ìë™ ë¡œê·¸ì¸)
      </label>
    </div>

    <button id="startBtn" class="primary" style="margin-top:12px;" onclick="startApp()">ì‹œì‘</button>
  </div>
</div>

<!-- ì•± -->
<div id="app" class="hidden">
  <header>
    <button id="nav-record" class="active" onclick="showScreen('record')">ì˜¤ëŠ˜ ê¸°ë¡</button>
    <button id="nav-today" onclick="showScreen('today')">ì˜¤ëŠ˜ í˜„í™©</button>
    <button id="nav-week" onclick="showScreen('week')">4ì£¼ í†µê³„</button>
    <button id="nav-fine" onclick="showScreen('fine4w')">4ì£¼ ë²Œê¸ˆ</button>
    <button id="nav-acc" onclick="showScreen('accTime')">ëˆ„ì ì‹œê°„</button>
  </header>

  <div class="container">

    <!-- ì˜¤ëŠ˜ ê¸°ë¡ -->
    <div id="record" class="screen">
      <div class="card">
        <h3 style="margin:0 0 10px;">ì˜¤ëŠ˜ ê³µë¶€ ê¸°ë¡</h3>
        <div class="small">ê¸°ì¤€ì¼: <span id="basisDate"></span> (ë§ˆê°: ë‹¤ìŒë‚  ìƒˆë²½ 3ì‹œ)</div>

        <div class="note small" style="margin-top:10px;">
          âœ… ì˜¤ëŠ˜ ê¸°ë¡ì´ 1ê°œë¼ë„ ìˆìœ¼ë©´ â€œê³µë¶€í•œ ë‚ (â­•)â€<br>
          âŒ ì˜¤ëŠ˜ ì•„ë¬´ ê¸°ë¡ì´ ì—†ìœ¼ë©´ â€œì ‘ì† ì•ˆ í•¨â€ìœ¼ë¡œ ë²Œê¸ˆ <b>15,000ì›</b> í™•ì •(ë§ˆê° í›„)
        </div>

        <hr class="sep">
        <button class="sub" onclick="openSub('word', this)">A. ë‹¨ì–´ 1ì´ˆ ë§í•˜ê¸°</button>
        <button class="sub" onclick="openSub('pattern', this)">B. íŒ¨í„´ì‹œí—˜</button>
        <button class="sub" onclick="openSub('speaking', this)">C. ë¬¸ì¥ë§í•˜ê¸°í›ˆë ¨</button>

        <!-- A -->
        <div id="sub-word" class="card hidden" style="margin-top:12px;">
          <p style="margin:0 0 8px;"><b>ë‹¨ì–´ 1ì´ˆ ë§í•˜ê¸°</b></p>
          <div class="small">ë²ˆí˜¸ êµ¬ê°„ ì„ íƒ + ê²°ê³¼(ë³µìˆ˜ ì„ íƒ)</div>

          <div style="margin-top:10px;">
            <label class="small">ë‹¨ì–´ ë²ˆí˜¸ êµ¬ê°„ (50ê°œ ë‹¨ìœ„)</label>
            <select id="wordRange"></select>
          </div>

          <div style="margin-top:10px;">
            <label class="small">ê²°ê³¼ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</label>
            <div class="chkGrid" id="wordOutcomeBox">
              <label><input type="checkbox" value="í•œ>ì˜ í•©ê²©">í•œ>ì˜ í•©ê²©</label>
              <label><input type="checkbox" value="í•œ>ì˜ ë¶ˆí•©ê²©">í•œ>ì˜ ë¶ˆí•©ê²©</label>
              <label><input type="checkbox" value="ì˜>í•œ í•©ê²©">ì˜>í•œ í•©ê²©</label>
              <label><input type="checkbox" value="ì˜>í•œ ë¶ˆí•©ê²©">ì˜>í•œ ë¶ˆí•©ê²©</label>
            </div>
            <p class="small" style="margin:8px 0 0;">ë²Œê¸ˆ: <b>ë¶ˆí•©ê²© ì²´í¬ 1ê°œë‹¹ 5,000ì›</b></p>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="primary" onclick="saveWord()">ì €ì¥</button>
            <button class="ghost" onclick="clearWordSelections()">ì„ íƒ ì´ˆê¸°í™”</button>
          </div>

          <div class="listItem">
            <div class="small"><b>ì˜¤ëŠ˜ ì €ì¥ëœ ë‹¨ì–´ ê¸°ë¡</b> (ê°™ì€ êµ¬ê°„ ì¤‘ë³µ ì €ì¥ ë¶ˆê°€)</div>
            <div id="todayWordItems" class="small" style="margin-top:8px;"></div>
          </div>
        </div>

        <!-- B -->
        <div id="sub-pattern" class="card hidden" style="margin-top:12px;">
          <p style="margin:0 0 8px;"><b>íŒ¨í„´ì‹œí—˜</b></p>

          <div style="margin-top:10px;">
            <label class="small">Day ì„ íƒ</label>
            <select id="patternDay"></select>
          </div>

          <div style="margin-top:10px;">
            <label class="small">ê²°ê³¼</label>
            <select id="patternResult">
              <option value="í•©ê²©">í•©ê²©</option>
              <option value="ë¶ˆí•©ê²©">ë¶ˆí•©ê²©</option>
            </select>
            <p class="small" style="margin:8px 0 0;">ë²Œê¸ˆ: ë¶ˆí•©ê²©ì´ë©´ <b>5,000ì›</b></p>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="primary" onclick="savePattern()">ì €ì¥</button>
            <button class="ghost" onclick="clearPatternInputs()">ì…ë ¥ ì´ˆê¸°í™”</button>
          </div>

          <div class="listItem">
            <div class="small"><b>ì˜¤ëŠ˜ ì €ì¥ëœ íŒ¨í„´ ê¸°ë¡</b> (ê°™ì€ Day ì¤‘ë³µ ì €ì¥ ë¶ˆê°€)</div>
            <div id="todayPatternItems" class="small" style="margin-top:8px;"></div>
          </div>
        </div>

        <!-- C -->
        <div id="sub-speaking" class="card hidden" style="margin-top:12px;">
          <p style="margin:0 0 8px;"><b>ë¬¸ì¥ë§í•˜ê¸°í›ˆë ¨</b></p>

          <div style="margin-top:10px;">
            <label class="small">í›ˆë ¨ ì‹œê°„</label>
            <select id="speakingTime">
              <option value="">ì„ íƒ</option>
              <option value="30ë¶„ ì´í•˜">30ë¶„ ì´í•˜</option>
              <option value="30ë¶„">30ë¶„</option>
              <option value="40ë¶„">40ë¶„</option>
              <option value="50ë¶„">50ë¶„</option>
              <option value="60ë¶„">60ë¶„</option>
              <option value="2ì‹œê°„">2ì‹œê°„</option>
              <option value="3ì‹œê°„">3ì‹œê°„</option>
              <option value="4ì‹œê°„">4ì‹œê°„</option>
            </select>
            <p class="small" style="margin:8px 0 0;">ë²Œê¸ˆ: <b>30ë¶„ ì´í•˜</b> ì„ íƒ ì‹œ <b>5,000ì›</b></p>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="primary" onclick="saveSpeaking()">ì €ì¥</button>
            <button class="danger" onclick="deleteSpeaking()">ì‚­ì œ</button>
          </div>

          <div class="listItem">
            <div class="small"><b>ì˜¤ëŠ˜ ì €ì¥ëœ ë¬¸ì¥ë§í•˜ê¸°í›ˆë ¨</b></div>
            <div id="todaySpeakingItem" class="small" style="margin-top:8px;"></div>
          </div>
        </div>

        <!-- ì˜¤ëŠ˜ ë²Œê¸ˆ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="card" style="margin-top:12px;">
          <div class="kpi">
            <div>
              <div class="small">ì˜¤ëŠ˜(ê¸°ì¤€ì¼) ë‚´ ë²Œê¸ˆ (ë§ˆê° ì „ì—ëŠ” â€œì˜ˆìƒâ€)</div>
              <div id="todayFineBig" class="big">0ì›</div>
            </div>
            <div><span class="pill">ìë™ ê³„ì‚°</span></div>
          </div>
          <div id="todayFineDetail" class="small" style="margin-top:10px;"></div>
        </div>

        <!-- íœ´ë¬´ ìš”ì²­ ë²„íŠ¼(ì²« í™”ë©´ ë§¨ ì•„ë˜) -->
        <div class="card" style="margin-top:12px;">
          <div class="small"><b>íŠ¹ë³„ ê¸°ëŠ¥</b> â€” ì˜¤ëŠ˜ ì‰¬ê³  ì‹¶ë‹¤ë©´?</div>
          <div class="small" style="margin-top:6px;">â€œì˜¤ëŠ˜ì€ ë‚˜ ì‰´ê²Œ!â€ë¥¼ ëˆ„ë¥´ë©´, ë‚˜ë¨¸ì§€ ë‘ ì‚¬ëŒì´ ëª¨ë‘ ìŠ¹ì¸í•´ì•¼ ì˜¤ëŠ˜ ë²Œê¸ˆì´ ìŠ¤í‚µë¼ìš”.</div>
          <div class="row" style="margin-top:10px;">
            <button class="ghost" onclick="requestRest()">ì˜¤ëŠ˜ì€ ë‚˜ ì‰´ê²Œ!</button>
          </div>
          <div id="restMyStatus" class="small" style="margin-top:10px;"></div>
        </div>

      </div>
    </div>

    <!-- ì˜¤ëŠ˜ í˜„í™© -->
    <div id="today" class="screen hidden"></div>

    <!-- 4ì£¼ í†µê³„ -->
    <div id="week" class="screen hidden"></div>

    <!-- 4ì£¼ ë²Œê¸ˆ -->
    <div id="fine4w" class="screen hidden">
      <div class="card">
        <div class="row" style="align-items:flex-start;">
          <div>
            <h3 style="margin:0 0 6px;">4ì£¼ ë²Œê¸ˆ</h3>
            <div class="small">ìµœê·¼ 28ì¼(ë§ˆê° ì§€ë‚œ ë‚ ì§œë§Œ í™•ì • ê³„ì‚°)</div>
          </div>
          <div style="text-align:right;">
            <button class="danger" onclick="resetAll()">âš  ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
            <div class="small" style="margin-top:6px;">ë¹„ë°€ë²ˆí˜¸: <b>20262026</b></div>
          </div>
        </div>
      </div>
      <div id="fine4wBody"></div>
    </div>

    <!-- ëˆ„ì ì‹œê°„ -->
    <div id="accTime" class="screen hidden">
      <div class="card banner">
        <b>ì˜ì–´ë§í•˜ê¸°í›ˆë ¨ì„ ì‹¤ì œ ì–¼ë§ˆë‚˜ í–ˆëŠ”ì§€ ëˆ„ì ëŸ‰ì´ í‘œì‹œë©ë‹ˆë‹¤</b>
        <div class="small" style="margin-top:6px;">
          â€» ì´ ëˆ„ì  ë°ì´í„°ëŠ” â€œì „ì²´ ë°ì´í„° ì´ˆê¸°í™”â€ë¥¼ ëˆŒëŸ¬ë„ ì§€ì›Œì§€ì§€ ì•Šì•„ìš”. ì•±ì´ ì‚´ì•„ìˆëŠ” í•œ ê³„ì† ëˆ„ì ë©ë‹ˆë‹¤.
        </div>
      </div>
      <div id="accBody"></div>
    </div>

  </div>
</div>

<!-- ëª¨ë‹¬ -->
<div id="modalRoot" class="hidden"></div>

<script>
/* =========================================================
   ì €ì¥ í‚¤
========================================================= */
const USERS = ["ì˜¤ì„¤ë€","ì˜¤ë¯¸ì§„","ê¹€ë¯¸ë‚˜"];
const KEY = "studyData";                 // ì¼ìë³„ ê¸°ë¡(ì´ˆê¸°í™” ëŒ€ìƒ)
const LS_USER = "currentUser";
const LS_REMEMBER = "rememberMe";
const KEY_ACC = "accSpeakingMinutes";    // ëˆ„ì ì‹œê°„(ì´ˆê¸°í™”í•´ë„ ìœ ì§€)

/* =========================================================
   ë‚ ì§œ/ë§ˆê° ë¡œì§
   - "ì˜¤ëŠ˜ ê¸°ë¡ ê°€ëŠ¥" ê¸°ì¤€ì¼: ìƒˆë²½ 3ì‹œ ì´ì „ì´ë©´ ì „ë‚ ì´ ê¸°ì¤€ì¼
   - ë²Œê¸ˆ í™•ì •ì€ "ë§ˆê° ì§€ë‚œ ë‚ ì§œ"ë§Œ ê³„ì‚°(ë¯¸ë¦¬ 15,000 ìŒ“ì´ëŠ” ë²„ê·¸ ë°©ì§€)
========================================================= */
function basisDateKey(){
  const d = new Date();
  if(d.getHours() < 3) d.setDate(d.getDate()-1);
  return d.toISOString().slice(0,10);
}
function dateKeyPlusDays(isoKey,delta){
  const d = new Date(isoKey); d.setDate(d.getDate()+delta);
  return d.toISOString().slice(0,10);
}
function isDateClosed(dateKey){
  // dateKey(YYYY-MM-DD)ì˜ ê¸°ë¡ ë§ˆê°: ë‹¤ìŒë‚  03:00 ì´í›„
  const d = new Date(dateKey + "T00:00:00");
  d.setDate(d.getDate()+1);
  d.setHours(3,0,0,0);
  return Date.now() >= d.getTime();
}

function load(){ return JSON.parse(localStorage.getItem(KEY)) || {}; }
function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }
function remembered(){ return localStorage.getItem(LS_REMEMBER) === "1"; }
function currentUser(){ return localStorage.getItem(LS_USER) || ""; }

// remember ì²´í¬ ì•ˆ í•œ ì„¸ì…˜ìš©
function getActiveUser(){ return currentUser() || window.__tempUser || ""; }

function ensureRow(data, dateKey, user){
  data[dateKey] ??= {};
  data[dateKey][user] ??= {};
  data[dateKey][user].wordAttempts ??= [];
  data[dateKey][user].patternAttempts ??= [];
  return data[dateKey][user];
}
function hasAnyRecord(row){
  if(!row) return false;
  const hasWord = (row.wordAttempts || []).length > 0;
  const hasPattern = (row.patternAttempts || []).length > 0;
  const hasSpeaking = typeof row.speakingTime === "string" && row.speakingTime.length > 0;
  return hasWord || hasPattern || hasSpeaking;
}

/* =========================================================
   íœ´ë¬´(ì‰¬ê¸°) ìš”ì²­ ë¡œì§
   - ì˜¤ëŠ˜(ê¸°ì¤€ì¼)ë§Œ ê°€ëŠ¥
   - ìš”ì²­ì + ë‚˜ë¨¸ì§€ ë‘ ëª… ëª¨ë‘ ìŠ¹ì¸ ì‹œ ë²Œê¸ˆ ìŠ¤í‚µ
========================================================= */
function ensureRestObj(data, dateKey){
  data[dateKey] ??= {};
  data[dateKey].__rest ??= {}; // ë‚ ì§œ ê³µìš© íœ´ë¬´ ìš”ì²­ë“¤
  // êµ¬ì¡°: data[dateKey].__rest[requester] = { requester, approvals:[], status:"pending|approved" }
  return data[dateKey].__rest;
}
function getRestState(data, dateKey, requester){
  return data[dateKey]?.__rest?.[requester] || null;
}
function isRestApproved(data, dateKey, requester){
  const s = getRestState(data, dateKey, requester);
  return !!(s && s.status === "approved");
}

function requestRest(){
  const u = getActiveUser();
  if(!u) return showModal("ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”", "ì´ë¦„ ì„ íƒ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.");
  const k = basisDateKey();
  const data = load();
  const rest = ensureRestObj(data, k);

  if(isDateClosed(k)){
    return showModal("ë§ˆê° í›„ì—ëŠ” íœ´ë¬´ ìš”ì²­ì´ ë¶ˆê°€í•´ìš”", "ì˜¤ëŠ˜(ê¸°ì¤€ì¼) ë§ˆê° ì „ê¹Œì§€ë§Œ ìš”ì²­í•  ìˆ˜ ìˆì–´ìš”.");
  }
  if(rest[u]?.status === "approved"){
    return showModal("ì´ë¯¸ íœ´ë¬´ ìŠ¹ì¸ ì™„ë£Œ!", "ì˜¤ëŠ˜ ë²Œê¸ˆì€ ìŠ¤í‚µë©ë‹ˆë‹¤ ğŸ˜´");
  }
  if(rest[u]?.status === "pending"){
    return showModal("ì´ë¯¸ íœ´ë¬´ ìš”ì²­ì´ ìˆì–´ìš”", "ë‹¤ë¥¸ ë‘ ì‚¬ëŒì´ ìŠ¹ì¸í•˜ë©´ ë²Œê¸ˆì´ ìŠ¤í‚µë¼ìš”.");
  }

  rest[u] = { requester:u, approvals:[], status:"pending", ts:Date.now() };
  save(data);
  renderAll();
  showModal("íœ´ë¬´ ìš”ì²­ ì™„ë£Œ", "ë‹¤ë¥¸ ë‘ ì‚¬ëŒì´ â€˜ìŠ¹ì¸â€™í•˜ë©´ ì˜¤ëŠ˜ ë²Œê¸ˆì´ ìŠ¤í‚µë¼ìš”.");
}

function approveRest(requester){
  const me = getActiveUser();
  const k = basisDateKey();
  const data = load();
  const rest = ensureRestObj(data, k);
  const state = rest[requester];
  if(!state) return;
  if(state.status === "approved") return;

  if(me === requester){
    return showModal("ë³¸ì¸ì€ ìŠ¹ì¸í•  ìˆ˜ ì—†ì–´ìš”", "ë‹¤ë¥¸ ë‘ ì‚¬ëŒì´ ìŠ¹ì¸í•´ì•¼ í•©ë‹ˆë‹¤.");
  }
  if(!state.approvals.includes(me)) state.approvals.push(me);

  // ìŠ¹ì¸ ì¡°ê±´: ë‚˜ë¨¸ì§€ 2ëª… ëª¨ë‘ ìŠ¹ì¸
  const needed = USERS.filter(x => x !== requester);
  const ok = needed.every(x => state.approvals.includes(x));
  if(ok) state.status = "approved";

  rest[requester] = state;
  save(data);
  renderAll();
}

/* =========================================================
   ë²Œê¸ˆ ê³„ì‚°
   ê·œì¹™:
   - ê¸°ë¡ 0ê°œë©´(ì ‘ì† ì•ˆí•¨) 15,000ì› (ë‹¨, ë§ˆê° ì§€ë‚œ ë‚ ì§œë§Œ í™•ì •)
   - ë‹¨ì–´: í•œ>ì˜ ë¶ˆí•©ê²©, ì˜>í•œ ë¶ˆí•©ê²© ì²´í¬ 1ê°œë‹¹ 5,000ì›
   - íŒ¨í„´: ë¶ˆí•©ê²© 5,000ì›
   - ë¬¸ì¥: 30ë¶„ ì´í•˜ 5,000ì›
   - íœ´ë¬´ ìŠ¹ì¸: ê·¸ ë‚ ì§œ ë²Œê¸ˆ 0ì›
========================================================= */
function calcFineForDate(dateKey, user){
  const data = load();
  // íœ´ë¬´ ìŠ¹ì¸ ì‹œ ë²Œê¸ˆ ìŠ¤í‚µ
  if(isRestApproved(data, dateKey, user)) return 0;

  const row = data[dateKey]?.[user];
  const has = hasAnyRecord(row);

  // ë§ˆê°ì´ ì•ˆ ì§€ë‚œ ë‚ ì§œ(ì˜¤ëŠ˜ ì§„í–‰ì¤‘)ëŠ” "ì ‘ì† ì•ˆí•¨ 15000"ì„ í™•ì •í•˜ì§€ ì•ŠìŒ
  // => 0 ê¸°ë¡ì´ì–´ë„ ì•„ì§ ê¸°íšŒ ìˆìŒ
  if(!isDateClosed(dateKey) && !has) return 0;

  if(!has) return 15000;

  let fine = 0;
  let wordFail = 0;
  for(const a of (row.wordAttempts || [])){
    for(const o of (a.outcomes || [])){
      if(o === "í•œ>ì˜ ë¶ˆí•©ê²©" || o === "ì˜>í•œ ë¶ˆí•©ê²©") wordFail++;
    }
  }
  fine += wordFail * 5000;
  fine += (row.patternAttempts || []).filter(p => p.result === "ë¶ˆí•©ê²©").length * 5000;
  if(row.speakingTime === "30ë¶„ ì´í•˜") fine += 5000;
  return fine;
}

/* =========================================================
   ëˆ„ì ì‹œê°„(ì´ˆê¸°í™”í•´ë„ ìœ ì§€)
========================================================= */
function loadAcc(){ return JSON.parse(localStorage.getItem(KEY_ACC)) || {}; }
function saveAcc(acc){ localStorage.setItem(KEY_ACC, JSON.stringify(acc)); }

function timeToMinutes(label){
  const map = {
    "30ë¶„ ì´í•˜": 30,
    "30ë¶„": 30,
    "40ë¶„": 40,
    "50ë¶„": 50,
    "60ë¶„": 60,
    "2ì‹œê°„": 120,
    "3ì‹œê°„": 180,
    "4ì‹œê°„": 240,
  };
  return map[label] ?? 0;
}
function addAcc(user, minutes){
  const acc = loadAcc();
  acc[user] = (acc[user] || 0) + minutes;
  saveAcc(acc);
}
function subAcc(user, minutes){
  const acc = loadAcc();
  acc[user] = Math.max(0, (acc[user] || 0) - minutes);
  saveAcc(acc);
}

/* =========================================================
   í™”ë©´ ì „í™˜
========================================================= */
function setNavActive(screenId){
  const ids = ["record","today","week","fine4w","accTime"];
  ids.forEach(id=>{
    const btn = document.getElementById("nav-"+(id==="fine4w"?"fine":id==="accTime"?"acc":id));
    if(btn) btn.classList.toggle("active", id === screenId);
  });
}
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  setNavActive(id);
  renderAll();
}
function openSub(subId, btnEl){
  document.querySelectorAll(".sub").forEach(b=>b.classList.remove("active"));
  if(btnEl) btnEl.classList.add("active");
  document.querySelectorAll("[id^='sub-']").forEach(s=>s.classList.add("hidden"));
  document.getElementById("sub-"+subId).classList.remove("hidden");
}

/* =========================================================
   ë‹¨ì–´/íŒ¨í„´/ë¬¸ì¥ ì €ì¥
========================================================= */
function buildWordRanges(){
  const sel = document.getElementById("wordRange");
  sel.innerHTML = "";
  for(let start=1; start<=1100; start+=50){
    const end = Math.min(start+49, 1100);
    const opt = document.createElement("option");
    opt.value = `${start}-${end}`;
    opt.textContent = `${start}-${end}ë²ˆ`;
    sel.appendChild(opt);
  }
}
function buildPatternDays(){
  const sel = document.getElementById("patternDay");
  sel.innerHTML = "";
  for(let i=1;i<=20;i++){
    const opt = document.createElement("option");
    opt.value = `Day${i}`;
    opt.textContent = `Day${i}`;
    sel.appendChild(opt);
  }
  sel.value = "Day1";
}
function getSelectedWordOutcomes(){
  return Array.from(document.querySelectorAll("#wordOutcomeBox input[type='checkbox']:checked")).map(x=>x.value);
}
function clearWordSelections(){
  document.querySelectorAll("#wordOutcomeBox input[type='checkbox']").forEach(x=>x.checked=false);
}
function saveWord(){
  const u = getActiveUser();
  if(!u) return showModal("ì´ë¦„ í•„ìš”", "ì´ë¦„ ì„ íƒ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.");
  const k = basisDateKey();
  if(isDateClosed(k)) return showModal("ë§ˆê° í›„ ì €ì¥ ë¶ˆê°€", "ìƒˆë²½ 3ì‹œ ì´í›„ì—ëŠ” ì „ë‚  ê¸°ë¡ì´ ì ê¹ë‹ˆë‹¤.");

  const data = load();
  const row = ensureRow(data, k, u);

  const range = document.getElementById("wordRange").value;
  const outcomes = getSelectedWordOutcomes();
  if(outcomes.length === 0) return showModal("ê²°ê³¼ ì„ íƒ í•„ìš”", "ê²°ê³¼ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•´ì¤˜.");

  if(row.wordAttempts.some(a => a.range === range)){
    return showModal("ì¤‘ë³µ ì €ì¥ ë°©ì§€", "ì˜¤ëŠ˜ì€ ì´ êµ¬ê°„ì´ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆì–´ìš”. (ì‚­ì œ í›„ ë‹¤ì‹œ ì €ì¥ ê°€ëŠ¥)");
  }

  row.wordAttempts.push({ range, outcomes, ts: Date.now() });
  save(data);
  clearWordSelections();
  renderAll();
}
function deleteWord(range){
  if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
  const u = getActiveUser();
  const data = load();
  const k = basisDateKey();
  const row = data[k]?.[u];
  if(!row) return;
  row.wordAttempts = (row.wordAttempts||[]).filter(a=>a.range !== range);
  save(data);
  renderAll();
}
function savePattern(){
  const u = getActiveUser();
  if(!u) return showModal("ì´ë¦„ í•„ìš”", "ì´ë¦„ ì„ íƒ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.");
  const k = basisDateKey();
  if(isDateClosed(k)) return showModal("ë§ˆê° í›„ ì €ì¥ ë¶ˆê°€", "ìƒˆë²½ 3ì‹œ ì´í›„ì—ëŠ” ì „ë‚  ê¸°ë¡ì´ ì ê¹ë‹ˆë‹¤.");

  const data = load();
  const row = ensureRow(data, k, u);

  const day = document.getElementById("patternDay").value;
  const result = document.getElementById("patternResult").value;

  if(row.patternAttempts.some(p => p.day === day)){
    return showModal("ì¤‘ë³µ ì €ì¥ ë°©ì§€", "ì˜¤ëŠ˜ì€ ì´ Dayê°€ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆì–´ìš”. (ì‚­ì œ í›„ ë‹¤ì‹œ ì €ì¥ ê°€ëŠ¥)");
  }

  row.patternAttempts.push({ day, result, ts: Date.now() });
  save(data);
  renderAll();
}
function deletePattern(day){
  if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
  const u = getActiveUser();
  const data = load();
  const k = basisDateKey();
  const row = data[k]?.[u];
  if(!row) return;
  row.patternAttempts = (row.patternAttempts||[]).filter(p=>p.day !== day);
  save(data);
  renderAll();
}
function clearPatternInputs(){
  document.getElementById("patternDay").value = "Day1";
  document.getElementById("patternResult").value = "í•©ê²©";
}
function saveSpeaking(){
  const u = getActiveUser();
  if(!u) return showModal("ì´ë¦„ í•„ìš”", "ì´ë¦„ ì„ íƒ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.");
  const k = basisDateKey();
  if(isDateClosed(k)) return showModal("ë§ˆê° í›„ ì €ì¥ ë¶ˆê°€", "ìƒˆë²½ 3ì‹œ ì´í›„ì—ëŠ” ì „ë‚  ê¸°ë¡ì´ ì ê¹ë‹ˆë‹¤.");

  const data = load();
  const row = ensureRow(data, k, u);

  const t = document.getElementById("speakingTime").value;
  if(!t) return showModal("ì‹œê°„ ì„ íƒ í•„ìš”", "í›ˆë ¨ ì‹œê°„ì„ ì„ íƒí•´ì¤˜.");
  if(row.speakingTime) return showModal("ì¤‘ë³µ ì €ì¥ ë°©ì§€", "ì˜¤ëŠ˜ì€ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆì–´ìš”. (ì‚­ì œ í›„ ë‹¤ì‹œ ì €ì¥)");

  row.speakingTime = t;
  save(data);

  // ëˆ„ì ì‹œê°„ ë°˜ì˜(ì´ˆê¸°í™”í•´ë„ ìœ ì§€)
  addAcc(u, timeToMinutes(t));

  renderAll();
}
function deleteSpeaking(){
  if(!confirm("ì‚­ì œí• ê¹Œìš”? (ëˆ„ì ì‹œê°„ë„ í•¨ê»˜ ë˜ëŒë¦½ë‹ˆë‹¤)")) return;
  const u = getActiveUser();
  const data = load();
  const k = basisDateKey();
  const row = data[k]?.[u];
  if(!row || !row.speakingTime) return;

  // ëˆ„ì ì‹œê°„ ë˜ëŒë¦¬ê¸°
  subAcc(u, timeToMinutes(row.speakingTime));

  delete row.speakingTime;
  save(data);
  renderAll();
}

/* =========================================================
   ë Œë”ë§
========================================================= */
function formatMinutes(mins){
  const h = Math.floor(mins/60);
  const m = mins % 60;
  if(h<=0) return `${m}ë¶„`;
  if(m===0) return `${h}ì‹œê°„`;
  return `${h}ì‹œê°„ ${m}ë¶„`;
}

function renderWordTodayList(){
  const el = document.getElementById("todayWordItems");
  const u = getActiveUser();
  const data = load();
  const k = basisDateKey();
  const arr = data[k]?.[u]?.wordAttempts || [];
  if(arr.length === 0){ el.innerHTML = `<span class="pill">ì—†ìŒ</span>`; return; }
  el.innerHTML = arr.map(a=>{
    const fails = (a.outcomes||[]).filter(o=>o==="í•œ>ì˜ ë¶ˆí•©ê²©"||o==="ì˜>í•œ ë¶ˆí•©ê²©").length;
    const fine = fails*5000;
    return `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-top:10px;">
        <div>
          <b>${a.range}ë²ˆ</b>
          <span class="pill" style="margin-left:6px;background:${fails? "#fee2e2":"#dcfce7"};color:${fails? "#991b1b":"#166534"};">
            ${fails? `ë¶ˆí•©ê²© ${fails}ê°œ / ${fine.toLocaleString()}ì›` : "ë¶ˆí•©ê²© ì—†ìŒ"}
          </span><br>
          <span class="small">${(a.outcomes||[]).join(", ")}</span>
        </div>
        <button class="danger" style="padding:8px 10px;" onclick="deleteWord('${a.range}')">ì‚­ì œ</button>
      </div>
    `;
  }).join("");
}

function renderPatternTodayList(){
  const el = document.getElementById("todayPatternItems");
  const u = getActiveUser();
  const data = load();
  const k = basisDateKey();
  const arr = data[k]?.[u]?.patternAttempts || [];
  if(arr.length === 0){ el.innerHTML = `<span class="pill">ì—†ìŒ</span>`; return; }
  el.innerHTML = arr.map(p=>{
    const fine = (p.result==="ë¶ˆí•©ê²©") ? 5000 : 0;
    return `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-top:10px;">
        <div><b>${p.day}</b>
          <span class="pill" style="background:${fine? "#fee2e2":"#dcfce7"};color:${fine? "#991b1b":"#166534"};">
            ${p.result}${fine? ` / ${fine.toLocaleString()}ì›`:""}
          </span>
        </div>
        <button class="danger" style="padding:8px 10px;" onclick="deletePattern('${p.day}')">ì‚­ì œ</button>
      </div>
    `;
  }).join("");
}

function renderSpeakingToday(){
  const el = document.getElementById("todaySpeakingItem");
  const u = getActiveUser();
  const data = load();
  const k = basisDateKey();
  const t = data[k]?.[u]?.speakingTime || "";
  if(!t){ el.innerHTML = `<span class="pill">ì—†ìŒ</span>`; return; }
  const fine = (t==="30ë¶„ ì´í•˜") ? 5000 : 0;
  el.innerHTML = `<span class="pill" style="background:${fine? "#fee2e2":"#dcfce7"};color:${fine? "#991b1b":"#166534"};">
    ${t}${fine? ` / ${fine.toLocaleString()}ì›`:" / ë²Œê¸ˆ ì—†ìŒ"}
  </span>`;
}

function renderTodayFine(){
  const u = getActiveUser();
  const k = basisDateKey();
  document.getElementById("basisDate").textContent = k;

  // ì˜¤ëŠ˜ ë²Œê¸ˆì€ "ë§ˆê° ì „ì´ë©´ ì˜ˆìƒê°’(ê¸°ë¡ 0ê°œë©´ 0ì› í‘œì‹œ)"
  const fine = calcFineForDate(k, u);
  document.getElementById("todayFineBig").textContent = fine.toLocaleString() + "ì›";

  const data = load();
  const row = data[k]?.[u];

  const detail = document.getElementById("todayFineDetail");

  if(isRestApproved(data, k, u)){
    detail.innerHTML = `ğŸ˜´ <b>íœ´ë¬´ ìŠ¹ì¸ ì™„ë£Œ</b> â€” ì˜¤ëŠ˜ ë²Œê¸ˆì€ ìŠ¤í‚µë©ë‹ˆë‹¤.`;
    return;
  }

  const has = hasAnyRecord(row);
  if(!has && !isDateClosed(k)){
    detail.innerHTML = `ì•„ì§ ë§ˆê° ì „ì´ë¼ â€œì ‘ì† ì•ˆ í•¨(15,000ì›)â€ì€ í™•ì •ë˜ì§€ ì•Šì•„ìš”.`;
    return;
  }
  if(!has && isDateClosed(k)){
    detail.innerHTML = `ì˜¤ëŠ˜ ê¸°ë¡ 0ê°œ â†’ <b>ì ‘ì† ì•ˆ í•¨ 15,000ì›</b>`;
    return;
  }

  let wordFail=0;
  for(const a of (row?.wordAttempts||[])){
    for(const o of (a.outcomes||[])){
      if(o==="í•œ>ì˜ ë¶ˆí•©ê²©"||o==="ì˜>í•œ ë¶ˆí•©ê²©") wordFail++;
    }
  }
  const patternFail=(row?.patternAttempts||[]).filter(p=>p.result==="ë¶ˆí•©ê²©").length;
  const speakUnder30=(row?.speakingTime==="30ë¶„ ì´í•˜");

  detail.innerHTML =
    `ë‹¨ì–´ ë¶ˆí•©ê²© ì²´í¬ ${wordFail}ê°œ â†’ ${(wordFail*5000).toLocaleString()}ì›<br>` +
    `íŒ¨í„´ ë¶ˆí•©ê²© ${patternFail}íšŒ â†’ ${(patternFail*5000).toLocaleString()}ì›<br>` +
    `ë¬¸ì¥ë§í•˜ê¸° 30ë¶„ ì´í•˜ ${speakUnder30?"ì˜ˆ":"ì•„ë‹ˆì˜¤"} â†’ ${(speakUnder30?5000:0).toLocaleString()}ì›`;
}

function renderRestMyStatus(){
  const u = getActiveUser();
  const k = basisDateKey();
  const data = load();
  const el = document.getElementById("restMyStatus");
  const s = getRestState(data, k, u);
  if(!u){ el.textContent=""; return; }
  if(!s){
    el.innerHTML = `<span class="pill">íœ´ë¬´ ìš”ì²­ ì—†ìŒ</span>`;
    return;
  }
  if(s.status==="approved"){
    el.innerHTML = `<span class="pill" style="background:#dcfce7;color:#166534;">íœ´ë¬´ ìŠ¹ì¸ ì™„ë£Œ âœ… (ë²Œê¸ˆ ìŠ¤í‚µ)</span>`;
    return;
  }
  const needed = USERS.filter(x=>x!==u);
  const approved = s.approvals || [];
  const left = needed.filter(x=>!approved.includes(x));
  el.innerHTML = `
    <span class="pill" style="background:#fff7ed;color:#9a3412;">íœ´ë¬´ ìš”ì²­ì¤‘ â³</span>
    <div class="small" style="margin-top:8px;">ìŠ¹ì¸ í•„ìš”: <b>${left.join(", ")}</b></div>
  `;
}

function renderTodayScreen(){
  const data = load();
  const k = basisDateKey();
  const el = document.getElementById("today");

  el.innerHTML = `
    <div class="card">
      <h3 style="margin:0 0 6px;">ì˜¤ëŠ˜ í˜„í™©</h3>
      <div class="small">${k} ê¸°ì¤€ (ë§ˆê°: ë‹¤ìŒë‚  3ì‹œ)</div>
    </div>
  `;

  // íœ´ë¬´ ìš”ì²­ íŒ¨ë„(ë‹¤ë¥¸ ë‘ ëª…ì´ ìŠ¹ì¸í•˜ëŠ” UI)
  const restAll = data[k]?.__rest || {};
  const pending = Object.values(restAll).filter(x=>x && x.status==="pending");
  if(pending.length>0){
    const me = getActiveUser();
    el.innerHTML += `
      <div class="card">
        <b>íœ´ë¬´ ìš”ì²­</b>
        <div class="small" style="margin-top:6px;">ìš”ì²­ìê°€ â€œì˜¤ëŠ˜ì€ ë‚˜ ì‰´ê²Œ!â€ë¥¼ ëˆŒë €ì–´ìš”. ë‚˜ë¨¸ì§€ ë‘ ì‚¬ëŒì´ ëª¨ë‘ ìŠ¹ì¸í•˜ë©´ ì˜¤ëŠ˜ ë²Œê¸ˆì´ ìŠ¤í‚µë©ë‹ˆë‹¤.</div>
        ${pending.map(req=>{
          const requester = req.requester;
          const approvals = req.approvals || [];
          const needed = USERS.filter(x=>x!==requester);
          const left = needed.filter(x=>!approvals.includes(x));
          const canApprove = me && me !== requester && !approvals.includes(me);
          return `
            <div class="listItem">
              <div><b>${requester}</b> â€” íœ´ë¬´ ìš”ì²­ì¤‘</div>
              <div class="small" style="margin-top:6px;">ìŠ¹ì¸ í˜„í™©: ${approvals.length}/2 (ë‚¨ì€ ìŠ¹ì¸: <b>${left.join(", ")}</b>)</div>
              <div class="row" style="margin-top:10px;">
                <button class="${canApprove?'primary':'ghost'}" onclick="${canApprove?`approveRest('${requester}')`:'void(0)'}" ${canApprove?'':'disabled'}>
                  ${canApprove?'ìŠ¹ì¸í•˜ê¸°':'ìŠ¹ì¸ ë¶ˆê°€'}
                </button>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  USERS.forEach(u=>{
    const row = data[k]?.[u];
    const ok = hasAnyRecord(row);
    const restOk = isRestApproved(data, k, u);

    let statusHTML = "";
    if(restOk){
      statusHTML = `<span class="ok">ğŸ˜´ íœ´ë¬´ ìŠ¹ì¸(ë²Œê¸ˆ ìŠ¤í‚µ)</span>`;
    }else if(ok){
      statusHTML = `<span class="ok">â­• ê¸°ë¡ ìˆìŒ</span>`;
    }else{
      statusHTML = `<span class="no">âŒ ê¸°ë¡ ì—†ìŒ</span> <span class="small">ë¯¸ì‹¤í–‰</span>`;
    }

    el.innerHTML += `<div class="card"><b>${u}</b><br>${statusHTML}</div>`;
  });
}

function renderWeekScreen(){
  const data = load();
  const baseKey = basisDateKey();
  const el = document.getElementById("week");

  el.innerHTML = `<div class="card"><h3 style="margin:0 0 6px;">4ì£¼ í†µê³„</h3><div class="small">ìµœê·¼ 28ì¼</div></div>`;

  USERS.forEach(u=>{
    let exec=0,no=0,wordFail=0,patternFail=0,speakUnder30=0,restDays=0;
    for(let i=0;i<28;i++){
      const dk = dateKeyPlusDays(baseKey, -i);
      const row = data[dk]?.[u];

      const restOk = isRestApproved(data, dk, u);
      if(restOk){
        restDays++;
      }else{
        if(hasAnyRecord(row)) exec++; else no++;
      }

      for(const a of (row?.wordAttempts||[])){
        for(const o of (a.outcomes||[])){
          if(o==="í•œ>ì˜ ë¶ˆí•©ê²©"||o==="ì˜>í•œ ë¶ˆí•©ê²©") wordFail++;
        }
      }
      patternFail += (row?.patternAttempts||[]).filter(p=>p.result==="ë¶ˆí•©ê²©").length;
      if(row?.speakingTime==="30ë¶„ ì´í•˜") speakUnder30++;
    }
    el.innerHTML += `
      <div class="card">
        <b>${u}</b><br>
        ì‹¤í–‰ ${exec} / ë¯¸ì‹¤í–‰ ${no} / íœ´ë¬´ìŠ¹ì¸ ${restDays}<br>
        ë‹¨ì–´ ë¶ˆí•©ê²© ì²´í¬ ${wordFail}ê°œ<br>
        íŒ¨í„´ ë¶ˆí•©ê²© ${patternFail}íšŒ<br>
        30ë¶„ ì´í•˜ ${speakUnder30}íšŒ
      </div>`;
  });
}

function renderFine4w(){
  const baseKey = basisDateKey();
  const body = document.getElementById("fine4wBody");

  body.innerHTML = "";

  // ìµœê·¼ 28ì¼ ì¤‘ "ë§ˆê° ì§€ë‚œ ë‚ ì§œ"ë§Œ í™•ì • ë²Œê¸ˆ ê³„ì‚°
  let totalAll = 0;
  const perUser = {};

  USERS.forEach(u=>{
    let sum = 0;
    for(let i=0;i<28;i++){
      const dk = dateKeyPlusDays(baseKey, -i);
      if(!isDateClosed(dk)) continue; // ë§ˆê° ì „ ë‚ ì§œëŠ” í™•ì • ê³„ì‚°ì—ì„œ ì œì™¸
      sum += calcFineForDate(dk, u);
    }
    perUser[u] = sum;
    totalAll += sum;
  });

  USERS.forEach(u=>{
    body.innerHTML += `<div class="card"><b>${u}</b><br>ì´ ë²Œê¸ˆ: <b>${perUser[u].toLocaleString()}ì›</b></div>`;
  });
  body.innerHTML += `<div class="card"><b>ì „ì²´ í•©ê³„</b><br><b>${totalAll.toLocaleString()}ì›</b></div>`;
}

function renderAcc(){
  const acc = loadAcc();
  const el = document.getElementById("accBody");
  let total = 0;

  el.innerHTML = "";
  USERS.forEach(u=>{
    const mins = acc[u] || 0;
    total += mins;
    el.innerHTML += `
      <div class="card">
        <b>${u}</b><br>
        ëˆ„ì  ë§í•˜ê¸°í›ˆë ¨: <b>${formatMinutes(mins)}</b>
      </div>
    `;
  });
  el.innerHTML += `
    <div class="card">
      <b>ì „ì²´ ëˆ„ì </b><br>
      í•©ê³„: <b>${formatMinutes(total)}</b>
    </div>
  `;
}

function renderAll(){
  if(!document.getElementById("app").classList.contains("hidden")){
    renderWordTodayList();
    renderPatternTodayList();
    renderSpeakingToday();
    renderTodayFine();
    renderRestMyStatus();

    renderTodayScreen();
    renderWeekScreen();
    renderFine4w();
    renderAcc();
  }
}

/* =========================================================
   ì´ˆê¸°í™” (ë¹„ë°€ë²ˆí˜¸ 20262026)
   - studyDataë§Œ ì‚­ì œ
   - ëˆ„ì ì‹œê°„(KEY_ACC)ì€ ìœ ì§€
========================================================= */
function resetAll(){
  const txt = prompt("ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
  if(txt !== "20262026") return alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”.");
  localStorage.removeItem(KEY);
  alert("ì´ˆê¸°í™” ì™„ë£Œ (ëˆ„ì ì‹œê°„ì€ ìœ ì§€ë©ë‹ˆë‹¤)");
  renderAll();
}

/* =========================================================
   ì‹œì‘(ë¡œê·¸ì¸) + ì›°ì»´ íŒì—…(ë””ìì¸)
========================================================= */
function showModal(title, body){
  const root = document.getElementById("modalRoot");
  root.classList.remove("hidden");
  root.innerHTML = `
    <div class="modalBack" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalTop">
          <h3>${escapeHtml(title)}</h3>
        </div>
        <div class="modalBody">
          <div class="bigMsg">${escapeHtml(body)}</div>
        </div>
        <div class="modalActions">
          <button class="primary" onclick="closeModal()">í™•ì¸</button>
        </div>
      </div>
    </div>
  `;
}
function showWelcome(){
  const msg = "3ë…„ë’¤ (ì„¤ë€Â·ë¯¸ì§„Â·ë¯¸ë‚˜) ì•¼ ë„ˆë‘!";
  const sub = "ì˜¤ëŠ˜ì˜ ì‘ì€ ê¸°ë¡ì´, 3ë…„ ë’¤ì˜ í° ì‹¤ë ¥ìœ¼ë¡œ âœ¨";
  const root = document.getElementById("modalRoot");
  root.classList.remove("hidden");
  root.innerHTML = `
    <div class="modalBack" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalTop">
          <h3>ğŸ”¥ ìŠ¤í„°ë”” ì‹œì‘!</h3>
        </div>
        <div class="modalBody">
          <div class="bigMsg">${escapeHtml(msg)}</div>
          <div class="subMsg">${escapeHtml(sub)}</div>
        </div>
        <div class="modalActions">
          <button class="primary" onclick="closeModal()">ê°€ì!</button>
        </div>
      </div>
    </div>
  `;
}
function closeModal(e){
  const root = document.getElementById("modalRoot");
  root.classList.add("hidden");
  root.innerHTML = "";
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function startApp(){
  const sel = document.getElementById("userSelect");
  const rememberChk = document.getElementById("rememberMe");
  const name = (sel?.value || "").trim();
  if(!name) return showModal("ì´ë¦„ ì„ íƒ í•„ìš”", "ì´ë¦„ì„ ì„ íƒí•œ ë’¤ ì‹œì‘ì„ ëˆŒëŸ¬ì¤˜.");

  if(rememberChk?.checked){
    localStorage.setItem(LS_USER, name);
    localStorage.setItem(LS_REMEMBER, "1");
    delete window.__tempUser;
  }else{
    localStorage.removeItem(LS_USER);
    localStorage.removeItem(LS_REMEMBER);
    window.__tempUser = name;
  }

  document.getElementById("nameScreen").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");

  showScreen("record");
  showWelcome();
  renderAll();
}

/* =========================================================
   ë¶€íŒ…
========================================================= */
function boot(){
  buildWordRanges();
  buildPatternDays();

  if(remembered() && currentUser()){
    document.getElementById("nameScreen").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    showScreen("record");
    // ìë™ ë¡œê·¸ì¸ì¼ ë•Œë„ í™˜ì˜ ëª¨ë‹¬(ì›í•˜ë©´ ë¹¼ë„ ë¨)
    showWelcome();
    renderAll();
  }else{
    // ì´ë¦„ ì„ íƒ í™”ë©´ ìœ ì§€
  }
}
document.addEventListener("DOMContentLoaded", boot);
</script>

</body>
</html>
